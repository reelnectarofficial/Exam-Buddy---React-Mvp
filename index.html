// ExamBuddy - Single-file React MVP
// Usage: This is a single-file React component (Next.js page or CRA App) demonstrating
// - Teacher dashboard (Board, Class, Subject, Chapter)
// - Deterministic question generator (no AI) that produces MCQs and short answers
// - PDF export (jsPDF)
// - SEO-friendly meta tags and content structure
// - Minimal, human-like, locally-targeted copy you can edit

// Install (example):
// npm install react react-dom jspdf file-saver
// Tailwind: this code uses Tailwind utility classes. If not using Tailwind, change classes accordingly.

import React, { useState } from 'react';
import { saveAs } from 'file-saver';
import jsPDF from 'jspdf';

export default function ExamBuddyMVP() {
  // Simple local dataset - replace with real curriculum JSON or DB
  const BOARDS = ['UP Board', 'CBSE', 'Bihar Board'];
  const CLASSES = ['Class 6', 'Class 7', 'Class 8', 'Class 9', 'Class 10'];
  const SUBJECTS = ['Science', 'Math', 'Social Science', 'English', 'Hindi'];

  const SAMPLE_CHAPTERS = {
    'Science': {
      'Cell Biology': `All living organisms are made of cells. The cell is the basic unit of life. Plants have cell walls. Mitochondria are the powerhouse of the cell. Photosynthesis takes place in chloroplasts.`,
      'Motion': `Motion is the change in position of an object. Speed is distance over time. Velocity is speed with direction.`
    },
    'Math': {
      'Polynomials': `A polynomial is an expression of variables and coefficients. Degree of a polynomial is the highest power of variable.`
    }
  };

  const [board, setBoard] = useState(BOARDS[0]);
  const [className, setClassName] = useState(CLASSES[2]);
  const [subject, setSubject] = useState(SUBJECTS[0]);
  const [chapter, setChapter] = useState(Object.keys(SAMPLE_CHAPTERS[subject])[0]);
  const [numMCQ, setNumMCQ] = useState(5);
  const [numShort, setNumShort] = useState(3);
  const [includeAnswers, setIncludeAnswers] = useState(false);
  const [generated, setGenerated] = useState({mcqs: [], shorts: []});

  // Lightweight deterministic "NLP" helpers (no AI) to make content look natural
  function splitSentences(text) {
    return text
      .split(/(?<=[.!?])\s+/)
      .map(s => s.trim())
      .filter(Boolean);
  }

  function pickNouns(sentence) {
    // Very simple heuristic: words longer than 4 letters that are not stopwords
    const stop = new Set(['the','is','are','of','in','a','an','and','to','with','for','that','this']);
    return sentence
      .replace(/[,.]/g,'')
      .split(/\s+/)
      .filter(w => w.length>4 && !stop.has(w.toLowerCase()));
  }

  function generateMCQsFromText(text, count) {
    const sentences = splitSentences(text);
    const pool = sentences.slice();
    const mcqs = [];
    let i = 0;
    while (mcqs.length < count && i < pool.length) {
      const s = pool[i];
      const nouns = pickNouns(s);
      if (nouns.length >= 1) {
        const answer = nouns[0];
        // make a simple blank question
        const question = s.replace(new RegExp(answer,'i'), '_____');
        // distractors: pick other nouns from other sentences
        const otherNouns = sentences
          .flatMap(sent => pickNouns(sent))
          .filter(n => n.toLowerCase() !== answer.toLowerCase());
        // deterministic choice: take first three different or make minor variants
        const options = [answer];
        for (let j=0; j<otherNouns.length && options.length<4; j++) {
          if (!options.includes(otherNouns[j])) options.push(otherNouns[j]);
        }
        while (options.length<4) options.push(answer + (options.length));
        // shuffle - deterministic by index
        const shuffled = options.slice();
        // simple rotation to vary position
        const rot = (mcqs.length) % 4;
        for (let r=0;r<rot;r++) shuffled.push(shuffled.shift());

        mcqs.push({question, options: shuffled, answer});
      }
      i++;
    }
    return mcqs;
  }

  function generateShortAnswers(text,count) {
    const sentences = splitSentences(text);
    const shorts = sentences.slice(0,count).map(s => ({question: `Explain: ${s.replace(/\.$/,'')}`, answer: s}));
    return shorts;
  }

  function onGenerate() {
    const chapText = SAMPLE_CHAPTERS[subject] && SAMPLE_CHAPTERS[subject][chapter] ? SAMPLE_CHAPTERS[subject][chapter] : 'No chapter text available. Please add content.';
    const mcqs = generateMCQsFromText(chapText, Number(numMCQ));
    const shorts = generateShortAnswers(chapText, Number(numShort));
    setGenerated({mcqs, shorts});
  }

  function exportPDF() {
    const doc = new jsPDF({unit:'pt'});
    let y = 40;
    doc.setFontSize(14);
    doc.text(`${board} — ${className} — ${subject} — ${chapter}`, 40, y);
    y+=20;
    doc.setFontSize(12);
    generated.mcqs.forEach((m, idx) => {
      y+=20;
      doc.text(`${idx+1}. ${m.question}`, 40, y);
      m.options.forEach((op,i)=>{ y+=16; doc.text(String.fromCharCode(65+i)+') '+op, 60, y); });
      if (includeAnswers) { y+=16; doc.text(`Answer: ${m.answer}`, 60, y); }
      if (y>720) { doc.addPage(); y=40; }
    });
    y+=20;
    generated.shorts.forEach((s,idx)=>{ y+=20; doc.text(`S${idx+1}. ${s.question}`,40,y); if(includeAnswers){ y+=16; doc.text(`Answer: ${s.answer}`,60,y);} if (y>720){ doc.addPage(); y=40; } });
    const blob = doc.output('blob');
    saveAs(blob, `${board}_${className}_${subject}_${chapter}_quiz.pdf`);
  }

  // Simple human-focused copy & SEO-friendly pieces
  const seoTitle = `${board} ${className} ${subject} - Chapter: ${chapter} | Printable MCQs & Short Questions`;
  const seoDesc = `Free printable, board-specific question paper generator for ${board} ${className} ${subject}. Create MCQs and short answer sets in minutes.`;

  return (
    <div className="min-h-screen bg-gray-50 p-6">
      {/* Simple SEO head - in Next.js replace with <Head> tags */}
      <header className="max-w-4xl mx-auto mb-6">
        <h1 className="text-2xl font-semibold">ExamBuddy — Quick Quiz Generator</h1>
        <p className="text-sm text-gray-600">{seoDesc}</p>
      </header>
      <main className="max-w-4xl mx-auto bg-white p-6 rounded shadow">
        <section className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label className="block text-sm">Board</label>
            <select className="w-full border p-2 rounded" value={board} onChange={e=>setBoard(e.target.value)}>
              {BOARDS.map(b=> <option key={b} value={b}>{b}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm">Class</label>
            <select className="w-full border p-2 rounded" value={className} onChange={e=>setClassName(e.target.value)}>
              {CLASSES.map(c=> <option key={c} value={c}>{c}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm">Subject</label>
            <select className="w-full border p-2 rounded" value={subject} onChange={e=>{ setSubject(e.target.value); const keys = Object.keys(SAMPLE_CHAPTERS[e.target.value]||{}); setChapter(keys[0]||''); }}>
              {SUBJECTS.map(s=> <option key={s} value={s}>{s}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm">Chapter</label>
            <select className="w-full border p-2 rounded" value={chapter} onChange={e=>setChapter(e.target.value)}>
              {Object.keys(SAMPLE_CHAPTERS[subject]||{}).map(ch=> <option key={ch} value={ch}>{ch}</option>)}
            </select>
          </div>
        </section>

        <section className="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label className="block text-sm">MCQs</label>
            <input type="number" value={numMCQ} onChange={e=>setNumMCQ(e.target.value)} className="w-full border p-2 rounded" />
          </div>
          <div>
            <label className="block text-sm">Short Qs</label>
            <input type="number" value={numShort} onChange={e=>setNumShort(e.target.value)} className="w-full border p-2 rounded" />
          </div>
          <div className="flex items-end">
            <label className="inline-flex items-center">
              <input type="checkbox" checked={includeAnswers} onChange={e=>setIncludeAnswers(e.target.checked)} className="mr-2" />
              <span className="text-sm">Include Answers</span>
            </label>
          </div>
        </section>

        <div className="mt-4 flex gap-3">
          <button onClick={onGenerate} className="px-4 py-2 bg-blue-600 text-white rounded">Generate</button>
          <button onClick={exportPDF} className="px-4 py-2 border rounded">Download PDF</button>
        </div>

        <section className="mt-6">
          <h2 className="font-semibold">Preview</h2>
          <div className="mt-3 space-y-4">
            {generated.mcqs.length===0 && <p className="text-sm text-gray-500">No questions yet. Click Generate.</p>}
            {generated.mcqs.map((m,i)=> (
              <div key={i} className="p-3 border rounded">
                <div className="font-medium">{i+1}. {m.question}</div>
                <ol className="list-decimal ml-6 mt-2">
                  {m.options.map((op,j)=>(<li key={j}>{op}</li>))}
                </ol>
                {includeAnswers && <div className="mt-2 text-sm text-green-700">Answer: {m.answer}</div>}
              </div>
            ))}

            {generated.shorts.map((s,i)=> (
              <div key={i} className="p-3 border rounded">
                <div className="font-medium">Short {i+1}. {s.question}</div>
                {includeAnswers && <div className="mt-2 text-sm text-green-700">Answer: {s.answer}</div>}
              </div>
            ))}
          </div>
        </section>

        <footer className="mt-6 text-sm text-gray-600">
          <div>Tip: Replace SAMPLE_CHAPTERS with your board's syllabus JSON. For SEO, add a static blog with chapters and sample PDFs to rank on long-tail keywords.</div>
        </footer>
      </main>
    </div>
  );
}
